<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oreza Œ≤</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="AIÊê≠Ëºâ„ÅÆ„Çπ„Éû„Éº„ÉàÊ§úÁ¥¢„ÉÅ„É£„ÉÉ„Éà„Ç¢„Éó„É™">
    <meta name="theme-color" content="#1a73e8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Oreza">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #ffffff;
            --fg: #000000;
            --accent: #4CAF50;
            --border: #e0e0e0;
            --user-bg: #E3F2FD;
            --assistant-bg: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg);
            color: var(--fg);
            height: 100svh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            height: 100svh;
            overflow: hidden;
        }

        /* Header */
        header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 90px 20px 12px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            flex-shrink: 0;
        }

        header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #0063B2;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .header-btn:hover {
            background: #f5f5f5;
        }

        .header-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Chat Area */
        #chatArea {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Message Styles */
        .message {
            display: flex;
            gap: 12px;
            max-width: 100%;
            margin-bottom: 16px;
            position: relative;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            display: none;
        }
        
        .message.user .message-avatar {
            background: var(--user-bg);
            color: white;
        }

        .message.assistant .message-avatar {
            background: var(--accent);
            color: white;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 16px;
            max-width: 75%;
            word-wrap: break-word;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .message.user .message-content {
            background: var(--user-bg);
            color: #000000;
        }

        .message.assistant .message-content {
            background: #f5f5f5;
            color: #000000;
            padding: 12px 16px;
            max-width: 100%;
            border-radius: 0;
        }

        /* Copy Button */
        .copy-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .message.assistant:hover .copy-btn {
            opacity: 1;
        }

        .copy-btn:hover {
            background: #f5f5f5;
        }

        .copy-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Thinking Indicator */
        .thinking-dots {
            font-size: 24px;
            animation: thinking 1.5s infinite;
        }

        @keyframes thinking {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Control Bar */
        #controlBar {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            border-top: 1px solid var(--border);
            background: var(--bg);
            justify-content: center;
            flex-shrink: 0;
        }

        .control-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .control-btn:hover {
            background: #f5f5f5;
        }

        .control-btn svg {
            width: 22px;
            height: 22px;
        }

        /* Input Area */
        #inputArea {
            display: flex;
            gap: 12px;
            padding: 12px 20px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            border-top: 1px solid var(--border);
            background: var(--bg);
            align-items: center;
            flex-shrink: 0;
        }

        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 24px;
            font-size: 16px;
            resize: none;
            outline: none;
            font-family: inherit;
        }

        #sendBtn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #0077BE;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        #sendBtn:hover {
            opacity: 0.8;
        }

        #sendBtn svg {
            width: 24px;
            height: 24px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--border);
            cursor: pointer;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: border-color 0.2s;
        }

        .avatar-option:hover,
        .avatar-option.selected {
            border-color: var(--accent);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            font-size: 14px;
        }

        .modal-btn.primary {
            background: var(--accent);
            color: white;
            border: none;
        }

        /* Hidden file input */
        #fileInput {
            display: none;
        }

        /* Connection Status Bar */
        #connectionStatus {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 8px 16px;
            text-align: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            z-index: 2000;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }
            to {
                transform: translateY(0);
            }
        }
        
        @keyframes wiggle {
            0%, 100% {
                transform: rotate(-2deg);
            }
            50% {
                transform: rotate(2deg);
            }
        }

        /* Login Screen Styles */
        .hidden {
            display: none !important;
        }

        #login-container {
            max-width: 420px;
            margin: 80px auto;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            background: #ffffff;
        }

        #login-container h1 {
            margin-bottom: 8px;
            font-size: 1.8rem;
            text-align: center;
        }

        #login-container p {
            margin-bottom: 24px;
            color: #666;
            text-align: center;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        #login-container input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        #login-container input:focus {
            outline: none;
            border-color: var(--accent);
        }

        #login-button {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        #login-button:hover {
            background: #45a049;
        }

        .error-message {
            color: #d9534f;
            margin-top: 12px;
            min-height: 1.2em;
            font-size: 0.9rem;
            text-align: center;
        }

        #logout-btn {
            position: absolute;
            top: 12px;
            right: 20px;
            padding: 8px 16px;
            background: #f5f5f5;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        #logout-btn:hover {
            background: #e0e0e0;
        }
        
        /* ÈÄè„Åã„ÅóÊàª„Çã„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
        .oreza-back-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            padding: 8px 14px;
            border-radius: 999px;
            
            font-size: 14px;
            font-weight: 500;
            
            background: rgba(0, 0, 0, 0.25);
            color: #fff;
            
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            
            cursor: pointer;
            user-select: none;
            z-index: 9999;
            
            opacity: 0;
            pointer-events: none;
            transition:
                opacity 0.2s ease-out,
                background 0.15s ease-out,
                transform 0.15s ease-out;
        }
        
        .oreza-back-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        .oreza-back-btn:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-container">
        <h1>Oreza Test Login</h1>
        <p>Êú¨Áï™„ÉÜ„Çπ„ÉàÁî®„Éû„Çπ„Çø„ÉºID„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>

        <div class="form-group">
            <label for="login-id">ID</label>
            <input id="login-id" type="text" autocomplete="username" placeholder="„Éû„Çπ„Çø„ÉºID">
        </div>

        <div class="form-group">
            <label for="login-password">Password</label>
            <input id="login-password" type="password" autocomplete="current-password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ">
        </div>

        <button id="login-button" type="button">„É≠„Ç∞„Ç§„É≥</button>
        <p id="login-error" class="error-message"></p>
    </div>

    <!-- Chat Container (hidden by default) -->
    <div id="chat-container" class="hidden">
        <!-- Connection Status Bar -->
        <div id="connectionStatus"></div>
        
        <!-- Header -->
        <header style="padding: 12px 20px 16px 20px; background: #f5f5f5;">
            <div style="max-width: 1200px; margin: 0 auto;">
                <!-- Search Form -->
                <div style="margin-bottom: 12px;">
                    <div style="position: relative; max-width: 800px; margin: 0 auto;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#999999" stroke-width="2" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; cursor: pointer;" id="header-search-icon">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="header-search-input" placeholder="Ê§úÁ¥¢„Åæ„Åü„ÅØURL„ÇíÂÖ•Âäõ" style="width: 100%; padding: 12px 50px; font-size: 15px; border: none; border-radius: 30px; outline: none; background: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: #333333;" />
                        <style>
                            #header-search-input::placeholder {
                                color: #c0c0c0;
                                opacity: 1;
                            }
                        </style>
                    </div>
                </div>
                <!-- Navigation Links -->
                <div style="display: flex; gap: 24px; justify-content: center; padding-top: 12px;">
                    <a id="header-chat-history-link" href="#" class="nav-link" style="text-decoration: none; color: #666666; font-size: 14px; font-weight: 400; padding: 8px 16px; border-radius: 8px; transition: all 0.2s; white-space: nowrap;">„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥</a>
                    <a id="header-tabs-link" href="#" class="nav-link" style="text-decoration: none; color: #666666; font-size: 14px; font-weight: 400; padding: 8px 16px; border-radius: 8px; transition: all 0.2s; white-space: nowrap;">„Çø„Éñ</a>
                    <a id="header-musickit-link" href="#" class="nav-link" style="text-decoration: none; color: #666666; font-size: 14px; font-weight: 400; padding: 8px 16px; border-radius: 8px; transition: all 0.2s; white-space: nowrap;">MusicKit</a>
                </div>
                <style>
                    .nav-link:hover {
                        background: #ffffff;
                        color: #333333;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                    }
                    .nav-link.active {
                        background: #ffffff;
                        color: #333333;
                        font-weight: 600;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                    }
                </style>
            </div>
        </header>


    <!-- Chat Area -->
    <div id="chatArea"></div>
    


    <!-- Control Bar -->
    <div id="controlBar">
        <button class="control-btn" id="navHomeBtn" onclick="goHome()" title="Home" style="min-width: 60px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
        </button>
        <button class="control-btn" id="cameraBtn" title="Camera">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
            </svg>
        </button>
        <button class="control-btn" id="imageBtn" title="Image">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
        </button>
        <button class="control-btn" id="searchBtn" title="Search">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        </button>
        <button class="control-btn" id="clearBtn" title="Clear">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        </button>
        <button class="control-btn" id="voiceBtn" title="Voice">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        </button>
    </div>



    <!-- Search Dialog -->
    <div id="search-dialog" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">
            <h2 style="margin: 0 0 16px 0; font-size: 20px; color: #0063B2; display: flex; align-items: center; gap: 8px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0063B2" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                WebÊ§úÁ¥¢
            </h2>
            
            <input id="search-input" type="text" placeholder="„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 16px; box-sizing: border-box;">
            
            <!-- Bookmark and History Links -->
            <div style="border-top: 1px solid #ddd; padding-top: 12px; display: flex; gap: 16px;">
                <a id="bookmark-link" href="#" style="color: #0063B2; text-decoration: none; font-size: 14px;">„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ</a>
                <a id="history-link" href="#" style="color: #0063B2; text-decoration: none; font-size: 14px;">Â±•Ê≠¥</a>
            </div>
            
            <div style="display: flex; gap: 8px; margin-top: 16px;">
                <button id="search-cancel-btn" style="flex: 1; padding: 12px; background: #f5f5f5; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">√ó</button>
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div id="inputArea">
        <textarea id="messageInput" placeholder="Oreza„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°" rows="1"></textarea>
        <button id="sendBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"></line>
                <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
        </button>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept="image/*">

    <!-- Avatar Selection Modal removed -->
    </div> <!-- End of chat-container -->

    <script>
        console.log('Script started loading...');
        
        // State
        let sessionId = null;
        let userAvatar = 'üë§';
        let aiAvatar = 'ü§ñ';
        
        
        function goHome() {
            chatArea.innerHTML = '';
            history.pushState({view: 'home'}, '', '/');
        }
        
        // Handle browser back/forward buttons
        window.addEventListener('popstate', (event) => {
            if (event.state) {
                restoreViewFromState(event.state);
            } else {
                // No state, go to home
                chatArea.innerHTML = '';
            }
        });
        
        function restoreViewFromState(state) {
            if (state.view === 'tabs') {
                showTabs();
            } else if (state.view === 'bookmarks') {
                showBookmarks();
            } else if (state.view === 'chat') {
                if (state.messages) {
                    chatArea.innerHTML = '';
                    state.messages.forEach(msg => {
                        addMessage(msg.role, msg.content, null, true, false);
                    });
                } else {
                    const messages = JSON.parse(localStorage.getItem('last_chat_messages') || '[]');
                    chatArea.innerHTML = '';
                    messages.forEach(msg => {
                        addMessage(msg.role, msg.content, null, true, false);
                    });
                }
            } else if (state.view === 'search') {
                if (state.results) {
                    displaySearchResults(state.query, state.results);
                } else {
                    const results = JSON.parse(localStorage.getItem('last_search_results') || '[]');
                    displaySearchResults(state.query, results);
                }
            } else {
                chatArea.innerHTML = '';
            }
        }
        

        
        // Connection management
        let connectionStatus = 'connected';
        let reconnectAttempts = 0;
        let keepAliveInterval = null;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const KEEP_ALIVE_INTERVAL = 30000; // 30 seconds

        // Login/Logout elements (will be initialized in DOMContentLoaded)
        let loginContainer;
        let chatContainer;
        let loginButton;
        let loginError;

        // Initialize
        function initializeApp() {
            // Get DOM elements after DOM is loaded
            loginContainer = document.getElementById("login-container");
            chatContainer = document.getElementById("chat-container");
            loginButton = document.getElementById("login-button");
            loginError = document.getElementById("login-error");
            
            console.log('Initializing app...', {loginButton, chatContainer});
            
            // Add global scroll-to-top button
            const scrollTopBtn = document.createElement('button');
            scrollTopBtn.id = 'global-scroll-to-top-btn';
            scrollTopBtn.innerHTML = '‚Üë';
            scrollTopBtn.style.cssText = 'position: fixed; bottom: 80px; right: 20px; width: 48px; height: 48px; border-radius: 50%; background: #999; color: white; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: none; z-index: 999; align-items: center; justify-content: center;';
            scrollTopBtn.onclick = () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                const chatArea = document.getElementById('chatArea');
                if (chatArea) {
                    chatArea.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            document.body.appendChild(scrollTopBtn);
            
            // Show/hide scroll-to-top button based on scroll position
            const updateScrollButton = () => {
                const btn = document.getElementById('global-scroll-to-top-btn');
                const chatArea = document.getElementById('chatArea');
                if (btn) {
                    const windowScroll = window.scrollY;
                    const chatScroll = chatArea ? chatArea.scrollTop : 0;
                    if (windowScroll > 100 || chatScroll > 100) {
                        btn.style.display = 'flex';
                    } else {
                        btn.style.display = 'none';
                    }
                }
            };
            
            window.addEventListener('scroll', updateScrollButton);
            
            // Also listen to chatArea scroll
            const chatArea = document.getElementById('chatArea');
            if (chatArea) {
                chatArea.addEventListener('scroll', updateScrollButton);
            }
            
            setupLoginHandlers();
            attachEventListeners();
        }
        
        function restoreViewFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view');
            
            if (!view || view === 'home') {
                // Home view - do nothing, chat area is already empty
                return;
            }
            
            if (view === 'bookmarks') {
                showBookmarks();
            } else if (view === 'tabs') {
                showTabs();
            } else if (view === 'search') {
                const query = urlParams.get('q');
                if (query) {
                    // Restore search results from localStorage
                    const savedSearch = localStorage.getItem('last_search_results');
                    if (savedSearch) {
                        const searchData = JSON.parse(savedSearch);
                        if (searchData.query === query) {
                            displaySearchResults(searchData.query, searchData.results, searchData.searchType || 'text');
                        }
                    }
                }
            } else if (view === 'chat') {
                // Restore chat from localStorage
                const savedChat = localStorage.getItem('last_chat_messages');
                if (savedChat) {
                    const messages = JSON.parse(savedChat);
                    const chatArea = document.getElementById('chatArea');
                    chatArea.innerHTML = '';
                    messages.forEach(msg => {
                        addMessage(msg.role, msg.content, null, true, false);
                    });
                }
            }
        }
        
        function displaySearchResults(query, results, searchType) {
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '';
            
            const searchIcon = searchType === 'image' ? 'üñºÔ∏è' : 'üîç';
            const titleDiv = document.createElement('div');
            titleDiv.id = 'search-results-title';
            titleDiv.style.cssText = 'font-weight: 600; font-size: 16px; margin: 24px 0 16px 0; padding: 0 16px; color: #202124;';
            titleDiv.textContent = `${searchIcon} Ê§úÁ¥¢ÁµêÊûú: ${query}`;
            chatArea.appendChild(titleDiv);
            
            if (results && results.length > 0) {
                results.forEach((r, i) => {
                    const cardDiv = document.createElement('div');
                    cardDiv.style.cssText = 'margin: 0 16px 16px 16px; padding: 16px; background: #ffffff; border: 1px solid #e8eaed; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative;';
                    
                    cardDiv.innerHTML = `
                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 8px;">
                            <a href="${r.link}" target="_blank" style="color: #0063B2; text-decoration: none; font-weight: 500;">
                                ${i + 1}. ${r.title}
                            </a>
                            <button class="bookmark-btn" data-title="${r.title.replace(/"/g, '&quot;')}" data-url="${r.link}" style="float: right; background: none; border: none; cursor: pointer; font-size: 18px; color: #5f6368; padding: 0; margin-left: 8px;" title="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´ËøΩÂä†">‚ô°</button>
                        </div>
                        <div style="color: #5f6368; font-size: 14px; margin-bottom: 8px; line-height: 1.6;">
                            ${r.snippet}
                        </div>
                        <div style="color: #006621; font-size: 13px; word-break: break-all;">
                            ${r.link}
                        </div>
                    `;
                    
                    chatArea.appendChild(cardDiv);
                });
            } else {
                const noResultDiv = document.createElement('div');
                noResultDiv.style.cssText = 'color: #888; padding: 20px; text-align: center; margin: 0 16px;';
                noResultDiv.textContent = 'Ê§úÁ¥¢ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ';
                chatArea.appendChild(noResultDiv);
            }
        }
        
        // Run initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // DOM is already loaded
            initializeApp();
        }

        // Login handlers
        function setupLoginHandlers() {
            if (loginButton) {
                loginButton.addEventListener("click", handleLogin);
                
                // Allow Enter key to login
                document.getElementById("login-password").addEventListener("keydown", (e) => {
                    if (e.key === "Enter") {
                        handleLogin();
                    }
                });
            }


        }

        async function handleLogin() {
            const idInput = document.getElementById("login-id");
            const passInput = document.getElementById("login-password");
            const userId = idInput.value.trim();
            const password = passInput.value;

            if (!userId || !password) {
                loginError.textContent = "ID „Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
                return;
            }

            loginError.textContent = "";
            loginButton.disabled = true;
            loginButton.textContent = "„É≠„Ç∞„Ç§„É≥‰∏≠...";

            try {
                const res = await fetch("/api/login", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    credentials: "include", // Essential for cookies
                    body: JSON.stringify({
                        user_id: userId,
                        password: password,
                    }),
                });

                if (!res.ok) {
                    loginError.textContent = "„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇID„Åã„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô„ÄÇ";
                    loginButton.disabled = false;
                    loginButton.textContent = "„É≠„Ç∞„Ç§„É≥";
                    return;
                }

                // Login successful - show chat screen
                loginContainer.classList.add("hidden");
                chatContainer.classList.remove("hidden");
                startKeepAlive();

                // Clear password field
                passInput.value = "";
                
                // Restore view from URL after login
                restoreViewFromURL();
            } catch (err) {
                console.error(err);
                loginError.textContent = "ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„Çâ„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ";
                loginButton.disabled = false;
                loginButton.textContent = "„É≠„Ç∞„Ç§„É≥";
            }
        }

        async function handleLogout() {
            try {
                await fetch("/api/logout", {
                    method: "POST",
                    credentials: "include",
                });
            } catch (err) {
                console.error("Logout error:", err);
            }

            // Show login screen
            chatContainer.classList.add("hidden");
            loginContainer.classList.remove("hidden");
            
            // Clear session
            sessionId = null;
            document.getElementById("chatArea").innerHTML = "";
            
            // Stop keep-alive
            if (keepAliveInterval) {
                clearInterval(keepAliveInterval);
                keepAliveInterval = null;
            }
        }

        // Avatar functions removed

        function attachEventListeners() {
            // Send message
            document.getElementById('sendBtn').onclick = sendMessage;
            document.getElementById('messageInput').onkeydown = (e) => {
                // Check if device is mobile
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || window.innerWidth <= 768;
                
                if (e.key === 'Enter') {
                    if (isMobile) {
                        // On mobile: allow Enter for newline, use send button to send
                        // Do nothing, allow default behavior (newline)
                    } else {
                        // On PC: Enter sends, Shift+Enter for newline
                        if (!e.shiftKey) {
                            e.preventDefault();
                            sendMessage();
                        }
                    }
                }
            };

            // Control buttons
            document.getElementById('cameraBtn').onclick = () => {
                document.getElementById('fileInput').setAttribute('capture', 'environment');
                document.getElementById('fileInput').click();
            };

            document.getElementById('imageBtn').onclick = () => {
                document.getElementById('fileInput').removeAttribute('capture');
                document.getElementById('fileInput').click();
            };

            document.getElementById('fileInput').onchange = handleImageUpload;

            document.getElementById('searchBtn').onclick = showSearchDialog;
            document.getElementById('clearBtn').onclick = clearChat;
            document.getElementById('voiceBtn').onclick = startVoiceInput;

            // Bookmark and History links in search dialog
            document.getElementById('bookmark-link').onclick = (e) => {
                e.preventDefault();
                window.location.href = '/?view=bookmarks';
            };
            document.getElementById('history-link').onclick = (e) => {
                e.preventDefault();
                showHistory();
            };

            // Header search input - Enter key
            document.getElementById('header-search-input').onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = e.target.value.trim();
                    if (query) {
                        performSearch(query);
                        e.target.value = '';
                    }
                }
            };
            
            // Header search icon click
            document.getElementById('header-search-icon').onclick = () => {
                const input = document.getElementById('header-search-input');
                const query = input.value.trim();
                if (query) {
                    performSearch(query);
                    input.value = '';
                }
            };
            
            // Header chat history link
            document.getElementById('header-chat-history-link').onclick = (e) => {
                e.preventDefault();
                showBookmarks();
                history.pushState({view: 'bookmarks'}, '', '/?view=bookmarks');
            };
            
            // Header tabs link
            document.getElementById('header-tabs-link').onclick = (e) => {
                e.preventDefault();
                showTabs();
                history.pushState({view: 'tabs'}, '', '/?view=tabs');
            };
            
            // Header MusicKit link
            document.getElementById('header-musickit-link').onclick = (e) => {
                e.preventDefault();
                showMusicKit();
                history.pushState({view: 'musickit'}, '', '/?view=musickit');
            };
            
            // Function to set active nav link
            function setActiveNavLink(linkId) {
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                document.getElementById(linkId).classList.add('active');
            }
            
            // Event delegation for bookmark buttons and search result links
            document.getElementById('chatArea').addEventListener('click', (e) => {
                // Bookmark button click
                if (e.target.classList.contains('bookmark-btn')) {
                    const title = e.target.getAttribute('data-title');
                    const url = e.target.getAttribute('data-url');
                    addBookmark(title, url);
                    e.target.textContent = '‚ô•';
                    e.target.style.color = '#ff0000';
                    
                    // Show confirmation message
                    const chatArea = document.getElementById('chatArea');
                    const confirmDiv = document.createElement('div');
                    confirmDiv.style.cssText = 'color: #1a73e8; padding: 8px 16px; font-size: 14px;';
                    confirmDiv.textContent = `‚úì „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü: ${title}`;
                    chatArea.appendChild(confirmDiv);
                    // Scroll to the search results title
                const searchResultsTitle = document.getElementById('search-results-title');
                if (searchResultsTitle) {
                    searchResultsTitle.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                }
                
                // Search result links now open directly in new tab via target="_blank"
                
                // Back to Oreza button click
                if (e.target.classList.contains('back-to-oreza-btn')) {
                    // Do nothing, stay in Oreza
                    e.preventDefault();
                }
            });
        }

        // Avatar modal functions removed

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;

            // Clear chat area for new conversation
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '';

            addMessage('user', text);
            input.value = '';

            // Add thinking indicator
            const thinkingMsg = addThinkingIndicator();

            try {
                // AI chat only (search patterns removed)
                if (false) {
                    // Extract search query
                    const match = text.match(searchMatch);
                    const searchQuery = match ? match[1] : text;
                    
                    // Perform search
                    const searchResponse = await fetch('/api/search', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            query: searchQuery,
                            search_type: 'web',
                            session_id: sessionId
                        })
                    });
                    
                    const searchData = await searchResponse.json();
                    sessionId = searchData.session_id;
                    
                    // Remove thinking indicator
                    removeThinkingIndicator(thinkingMsg);
                    
                    // Display search results
                    const chatArea = document.getElementById('chatArea');
                    const titleDiv = document.createElement('div');
                    titleDiv.style.cssText = 'font-weight: 600; font-size: 16px; margin: 24px 0 16px 0; padding: 0 16px; color: #202124;';
                    titleDiv.textContent = `üîç Ê§úÁ¥¢ÁµêÊûú: ${searchQuery}`;
                    chatArea.appendChild(titleDiv);
                    
                    // Blocklist of domains to exclude
                    const blockedDomains = ['anatoliystoneproducts.com'];
                    
                    if (searchData.results && searchData.results.length > 0) {
                        // Filter out blocked domains
                        const filteredResults = searchData.results.filter(r => {
                            try {
                                const url = new URL(r.link);
                                return !blockedDomains.some(domain => url.hostname.includes(domain));
                            } catch (e) {
                                return true; // Keep if URL parsing fails
                            }
                        });
                        
                        filteredResults.forEach((r, i) => {
                            const cardDiv = document.createElement('div');
                            cardDiv.style.cssText = 'margin: 0 16px 16px 16px; padding: 16px; background: #ffffff; border: 1px solid #e8eaed; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative;';
                            
                            cardDiv.innerHTML = `
                                <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 8px;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">
                                            <a href="${r.link}" target="_blank" style="color: #1a0dab; text-decoration: none;">
                                                ${i + 1}. ${r.title}
                                            </a>
                                        </div>
                                        <div style="color: #5f6368; font-size: 14px; margin-bottom: 8px; line-height: 1.6;">
                                            ${r.snippet}
                                        </div>
                                        <div style="color: #006621; font-size: 13px; word-break: break-all;">
                                            ${r.link}
                                        </div>
                                    </div>
                                    <button class="bookmark-btn" data-title="${r.title.replace(/"/g, '&quot;')}" data-url="${r.link}" style="background: none; border: none; cursor: pointer; font-size: 20px; color: #5f6368; padding: 0; margin-top: 2px;" title="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´ËøΩÂä†">‚ô°</button>
                                </div>
                            `;
                            
                            chatArea.appendChild(cardDiv);
                        });
                    }
                    
                    // AI analysis
                    addMessage('assistant', 'ü§ñ AI„ÅåÊ§úÁ¥¢ÁµêÊûú„ÇíÂàÜÊûê‰∏≠...');
                    
                    const analysisResponse = await fetch('/api/search/analyze', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            query: searchQuery,
                            results: searchData.results,
                            session_id: sessionId
                        })
                    });
                    
                    const analysisData = await analysisResponse.json();
                    sessionId = analysisData.session_id;
                    
                    // Remove analyzing message
                    chatArea.removeChild(chatArea.lastChild);
                    
                    // Add AI analysis
                    addMessage('assistant', analysisData.analysis, null, false, true);
                    
                    return;
                }
                
                // „Ç´„É¨„É≥„ÉÄ„ÉºÈñ¢ÈÄ£„ÇØ„Ç®„É™„ÅÆÊ§úÂá∫ÔºàÊòéÁ¢∫„Å™‰∫àÂÆöÊìç‰Ωú„ÅÆ„ÅøÔºâ
                const calendarActionPatterns = [
                    /(ÊòéÊó•|‰ªäÊó•|Êù•ÈÄ±|Êù•Êúà|\d+Êúà\d+Êó•).+(„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞|‰ºöË≠∞|ÁóÖÈô¢|„ÇØ„É™„Éã„ÉÉ„ÇØ|Ê≠ØÂåªËÄÖ|„Ç¥„ÉüÂá∫„Åó)/,
                    /(‰∫àÂÆö|„Çπ„Ç±„Ç∏„É•„Éº„É´).+(‰ΩúÊàê|ËøΩÂä†|ÁôªÈå≤|ÂÖ•„Çå)/,
                    /(‰∫àÂÆö|„Çπ„Ç±„Ç∏„É•„Éº„É´).+(ÂâäÈô§|Ê∂à„Åó|„Ç≠„É£„É≥„Çª„É´)/,
                    /(‰∫àÂÆö|„Çπ„Ç±„Ç∏„É•„Éº„É´).+(Â§âÊõ¥|‰øÆÊ≠£|Á∑®ÈõÜ)/,
                    /(‰ªäÊó•|ÊòéÊó•|Êù•ÈÄ±|‰ªäÈÄ±).+‰∫àÂÆö.+(Êïô„Åà|Ë¶ã„Åõ|Á¢∫Ë™ç)/,
                    /\d+ÊôÇ.+(„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞|‰ºöË≠∞|ÁóÖÈô¢|„ÇØ„É™„Éã„ÉÉ„ÇØ|Ê≠ØÂåªËÄÖ)/,
                    /(„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞|‰ºöË≠∞|ÁóÖÈô¢|„ÇØ„É™„Éã„ÉÉ„ÇØ|Ê≠ØÂåªËÄÖ).+(‰∫àÂÆö|„É™„Éû„Ç§„É≥„Éâ)/,
                    /(„É™„Éû„Ç§„É≥„Éâ|ÈÄöÁü•).+(Ë®≠ÂÆö|ÁôªÈå≤)/
                ];
                const isCalendarQuery = calendarActionPatterns.some(pattern => pattern.test(text));

                if (isCalendarQuery) {
                    // AI„Ç´„É¨„É≥„ÉÄ„Éº„Éá„Ç£„Çπ„Éë„ÉÉ„ÉÅAPI„Çí‰ΩøÁî®
                    const response = await fetch('/api/ai/calendar/dispatch', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            user_input: text,
                            context: {
                                session_id: sessionId,
                                last_event_id: window.lastEventId || null
                            }
                        })
                    });

                    const data = await response.json();
                    
                    // Remove thinking indicator
                    removeThinkingIndicator(thinkingMsg);
                    
                    if (data.success) {
                        // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                        addMessage('assistant', data.message || '„Ç´„É¨„É≥„ÉÄ„ÉºÊìç‰Ωú„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ');
                        
                        // „Ç§„Éô„É≥„ÉàID„Çí‰øùÂ≠òÔºàÂæåÁ∂ö„ÅÆÊõ¥Êñ∞„ÉªÂâäÈô§Áî®Ôºâ
                        if (data.result && data.result.id) {
                            window.lastEventId = data.result.id;
                        }
                        
                        // „Ç´„É¨„É≥„ÉÄ„Éº„Éö„Éº„Ç∏„Å∏„ÅÆ„É™„É≥„ÇØ„ÇíËøΩÂä†
                        if (data.intent === 'CREATE_EVENT') {
                            const linkMsg = '\n\n<a href="/calendar_v2.html"  style="color: #4CAF50; text-decoration: none;">üìÖ „Ç´„É¨„É≥„ÉÄ„Éº„ÅßÁ¢∫Ë™ç</a>';
                            addMessage('assistant', linkMsg, null, false, true);
                        }
                    } else {
                        // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                        addMessage('assistant', `„Ç®„É©„Éº: ${data.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'}`);
                    }
                } else {
                    // ÈÄöÂ∏∏„ÅÆ„ÉÅ„É£„ÉÉ„ÉàAPI
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            messages: [{role: 'user', content: text}],
                            session_id: sessionId
                        })
                    });

                    const data = await response.json();
                    sessionId = data.session_id;
                    
                    // Remove thinking indicator
                    removeThinkingIndicator(thinkingMsg);
                    
                    addMessage('assistant', data.response, null, false, true);
                    
                    // Save chat to localStorage and navigate to chat view
                    const messages = [
                        {role: 'user', content: text},
                        {role: 'assistant', content: data.response}
                    ];
                    localStorage.setItem('last_chat_messages', JSON.stringify(messages));
                    
                    // Update URL without reload
                    history.pushState({view: 'chat', messages}, '', '/?view=chat');
                }
            } catch (error) {
                // Remove thinking indicator
                removeThinkingIndicator(thinkingMsg);
                addMessage('assistant', 'Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }

        function addThinkingIndicator() {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant thinking-indicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = aiAvatar;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = '<span class="thinking-dots">‚Ä¢‚Ä¢‚Ä¢</span>';
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
            
            return messageDiv;
        }

        function removeThinkingIndicator(thinkingMsg) {
            if (thinkingMsg && thinkingMsg.parentNode) {
                thinkingMsg.parentNode.removeChild(thinkingMsg);
            }
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                // Convert image to Base64
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Image = e.target.result;
                    
                    // Display image in user message bubble
                    addMessage('user', '', base64Image);
                    
                    // Show analyzing message
                    addMessage('assistant', 'ÁîªÂÉè„ÇíÂàÜÊûê„Åó„Å¶„ÅÑ„Åæ„Åô...');
                    
                    try {
                        const response = await fetch('/api/analyze_image', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                image_data: base64Image,
                                session_id: sessionId
                            })
                        });

                        const data = await response.json();
                        sessionId = data.session_id;
                        
                        // Remove analyzing message and add actual analysis
                        const chatArea = document.getElementById('chatArea');
                        chatArea.removeChild(chatArea.lastChild);
                        addMessage('assistant', data.analysis, null, false, true);
                    } catch (error) {
                        console.error('Image analysis error:', error);
                        // Remove analyzing message
                        const chatArea = document.getElementById('chatArea');
                        chatArea.removeChild(chatArea.lastChild);
                        addMessage('assistant', 'ÁîªÂÉè„ÅÆÂàÜÊûê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
                    }
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('File read error:', error);
                addMessage('assistant', 'ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
            }

            event.target.value = '';
        }

        async function performSearch(query, searchType = 'web') {
            if (!query) return;
            
            // Check if query is a URL
            const urlPattern = /^(https?:\/\/|www\.)[^\s]+$/i;
            if (urlPattern.test(query)) {
                // If it's a URL, show direct link and fetch AI summary
                const url = query.startsWith('http') ? query : 'https://' + query;
                addMessage('user', `üîó URL: ${query}`);
                
                const chatArea = document.getElementById('chatArea');
                
                // Extract title from URL (use domain name)
                let title = url;
                try {
                    const urlObj = new URL(url);
                    title = urlObj.hostname.replace('www.', '');
                } catch (e) {
                    title = url;
                }
                
                // Show loading state
                const linkDiv = document.createElement('div');
                linkDiv.style.cssText = 'margin: 16px; padding: 16px; background: #f0f7ff; border: 1px solid #0063B2; border-radius: 8px; position: relative;';
                linkDiv.innerHTML = `
                    <button class="bookmark-btn" data-title="${title}" data-url="${url}" style="position: absolute; top: 16px; right: 16px; background: none; border: none; cursor: pointer; font-size: 18px; color: #5f6368; padding: 0;" title="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´ËøΩÂä†">‚ô°</button>
                    <div style="font-size: 15px; color: #333; margin-bottom: 12px; padding-right: 30px;">ü§ñ AI„Åå„É™„É≥„ÇØÂÖà„ÇíÂàÜÊûê‰∏≠...</div>
                    <div style="margin-top: 12px; font-size: 13px; color: #5f6368; word-break: break-all;">${url}</div>
                `;
                chatArea.appendChild(linkDiv);
                
                // Fetch AI summary
                try {
                    const summaryResponse = await fetch('/api/url/summarize', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ url: url })
                    });
                    
                    const summaryData = await summaryResponse.json();
                    
                    // Determine safety color and icon
                    let safetyColor = '#4CAF50';
                    let safetyIcon = '‚úÖ';
                    let safetyText = 'ÂÆâÂÖ®';
                    
                    if (summaryData.safety === 'caution') {
                        safetyColor = '#FF9800';
                        safetyIcon = '‚ö†Ô∏è';
                        safetyText = 'Ê≥®ÊÑè';
                    } else if (summaryData.safety === 'danger') {
                        safetyColor = '#F44336';
                        safetyIcon = '‚õî';
                        safetyText = 'Âç±Èô∫';
                    }
                    
                    // Update with summary
                    linkDiv.innerHTML = `
                        <button class="bookmark-btn" data-title="${summaryData.title || title}" data-url="${url}" style="position: absolute; top: 16px; right: 16px; background: none; border: none; cursor: pointer; font-size: 18px; color: #5f6368; padding: 0;" title="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´ËøΩÂä†">‚ô°</button>
                        <div style="font-weight: 600; font-size: 16px; color: #333; margin-bottom: 8px; padding-right: 30px;">${summaryData.title || title}</div>
                        <div style="color: ${safetyColor}; font-size: 14px; font-weight: 600; margin-bottom: 12px;">${safetyIcon} ${safetyText}</div>
                        ${summaryData.safety_note ? `<div style="color: ${safetyColor}; font-size: 13px; margin-bottom: 12px;">${summaryData.safety_note}</div>` : ''}
                        <div style="color: #5f6368; font-size: 14px; line-height: 1.6; margin-bottom: 12px;">${summaryData.summary}</div>
                        <a href="${url}" target="_blank" rel="noopener noreferrer" style="color: #0063B2; font-size: 14px; font-weight: 500; text-decoration: none;">üîó „É™„É≥„ÇØ„ÇíÈñã„Åè</a>
                        <div style="margin-top: 12px; font-size: 13px; color: #5f6368; word-break: break-all;">${url}</div>
                    `;
                    
                } catch (error) {
                    console.error('URL summary error:', error);
                    // Fallback to simple link on error
                    linkDiv.innerHTML = `
                        <button class="bookmark-btn" data-title="${title}" data-url="${url}" style="position: absolute; top: 16px; right: 16px; background: none; border: none; cursor: pointer; font-size: 18px; color: #5f6368; padding: 0;" title="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´ËøΩÂä†">‚ô°</button>
                        <div style="font-size: 15px; color: #333; margin-bottom: 12px; padding-right: 30px;">„Åì„ÅÆ„É™„É≥„ÇØ„ÇíÈñã„Åç„Åæ„Åô„Åã?</div>
                        <a href="${url}" target="_blank" rel="noopener noreferrer" style="color: #0063B2; font-size: 14px; font-weight: 500; text-decoration: none;">üîó „É™„É≥„ÇØ„ÇíÈñã„Åè</a>
                        <div style="margin-top: 12px; font-size: 13px; color: #5f6368; word-break: break-all;">${url}</div>
                    `;
                }
                
                return;
            }
            
            // Auto-add "web" to queries containing app names
            const appKeywords = ['youtube', 'facebook', 'instagram', 'twitter', 'tiktok', 'x.com'];
            let modifiedQuery = query;
            
            if (searchType === 'web') {
                const queryLower = query.toLowerCase();
                const hasAppKeyword = appKeywords.some(keyword => queryLower.includes(keyword));
                const hasWebKeyword = queryLower.includes('web');
                
                // Add "web" if query contains app name but doesn't already have "web"
                if (hasAppKeyword && !hasWebKeyword) {
                    modifiedQuery = query + ' web';
                }
            }
            
            const searchIcon = searchType === 'image' ? 'üñºÔ∏è' : 'üîç';
            addMessage('user', `${searchIcon} Ê§úÁ¥¢: ${query}`);

            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query: modifiedQuery,
                        session_id: sessionId,
                        search_type: searchType
                    })
                });

                const data = await response.json();
                sessionId = data.session_id;
                
                // Build simple card-based search results (not in message bubble)
                const chatArea = document.getElementById('chatArea');
                
                // Add search results title
                const titleDiv = document.createElement('div');
                titleDiv.style.cssText = 'font-weight: 600; font-size: 16px; margin: 24px 0 16px 0; padding: 0 16px; color: #202124;';
                titleDiv.textContent = `${searchIcon} Ê§úÁ¥¢ÁµêÊûú: ${query}`;
                titleDiv.id = 'search-results-title';
                chatArea.appendChild(titleDiv);
                
                // Blocklist of domains to exclude
                const blockedDomains = ['anatoliystoneproducts.com'];
                
                if (data.results && data.results.length > 0) {
                    // Filter out blocked domains
                    const filteredResults = data.results.filter(r => {
                        try {
                            const url = new URL(r.link);
                            return !blockedDomains.some(domain => url.hostname.includes(domain));
                        } catch (e) {
                            return true; // Keep if URL parsing fails
                        }
                    });
                    
                    // Web search results - card layout with safety check for first result
                    filteredResults.forEach((r, i) => {
                            const cardDiv = document.createElement('div');
                            cardDiv.style.cssText = 'margin: 0 16px 16px 16px; padding: 16px; background: #ffffff; border: 1px solid #e8eaed; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative;';
                            
                            cardDiv.innerHTML = `
                                <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 8px;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">
                                            <a href="${r.link}" target="_blank" style="color: #1a0dab; text-decoration: none;">
                                                ${i + 1}. ${r.title}
                                            </a>
                                        </div>
                                        <div style="color: #5f6368; font-size: 14px; margin-bottom: 8px; line-height: 1.6;">
                                            ${r.snippet}
                                        </div>
                                        <div style="color: #006621; font-size: 13px; word-break: break-all;">
                                            ${r.link}
                                        </div>
                                    </div>
                                    <button class="bookmark-btn" data-title="${r.title.replace(/"/g, '&quot;')}" data-url="${r.link}" style="background: none; border: none; cursor: pointer; font-size: 20px; color: #5f6368; padding: 0; margin-top: 2px;" title="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´ËøΩÂä†">‚ô°</button>
                                </div>
                            `;
                            
                            chatArea.appendChild(cardDiv);
                            
                            // Show loading state for first 5 results
                            if (i < 5) {
                                const loadingDiv = document.createElement('div');
                                loadingDiv.style.cssText = 'color: #888; font-size: 13px; margin: -8px 16px 8px 32px;';
                                loadingDiv.textContent = 'ü§ñ AI„ÅåÂÆâÂÖ®ÊÄß„ÇíÁ¢∫Ë™ç‰∏≠...';
                                loadingDiv.id = 'safety-loading';
                                cardDiv.insertBefore(loadingDiv, cardDiv.children[1]);
                                
                                // Fetch AI safety check for first result
                                fetch('/api/url/summarize', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({ url: r.link })
                                }).then(response => response.json())
                                .then(summaryData => {
                                    // Determine safety color
                                    let safetyColor = '#4CAF50';
                                    let safetyIcon = '‚úÖ';
                                    let safetyText = 'ÂÆâÂÖ®';
                                    
                                    if (summaryData.safety === 'caution') {
                                        safetyColor = '#FF9800';
                                        safetyIcon = '‚ö†Ô∏è';
                                        safetyText = 'Ê≥®ÊÑè';
                                    } else if (summaryData.safety === 'danger') {
                                        safetyColor = '#F44336';
                                        safetyIcon = '‚õî';
                                        safetyText = 'Âç±Èô∫';
                                    }
                                    
                                    // Replace loading with safety badge
                                    loadingDiv.style.cssText = `color: ${safetyColor}; font-size: 14px; font-weight: 600; margin: -8px 16px 8px 32px;`;
                                    loadingDiv.textContent = `${safetyIcon} ${safetyText}`;
                                }).catch(error => {
                                    console.error('Safety check error:', error);
                                    // Remove loading on error
                                    if (loadingDiv.parentNode) {
                                        loadingDiv.parentNode.removeChild(loadingDiv);
                                    }
                                });
                            }
                    });
                } else {
                    const noResultDiv = document.createElement('div');
                    noResultDiv.style.cssText = 'color: #888; padding: 20px; text-align: center; margin: 0 16px;';
                    noResultDiv.textContent = 'Ê§úÁ¥¢ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ';
                    chatArea.appendChild(noResultDiv);
                }
                
                // Scroll to the search results title
                const searchResultsTitle = document.getElementById('search-results-title');
                if (searchResultsTitle) {
                    searchResultsTitle.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                // Save search results to localStorage and navigate
                localStorage.setItem('last_search_results', JSON.stringify({
                    query: query,
                    results: data.results || [],
                    searchType: 'text'
                }));
                
                // Update URL without reload
                history.pushState({view: 'search', query, results}, '', `/?view=search&q=${encodeURIComponent(query)}`);
            } catch (error) {
                console.error('Search error:', error);
                // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„Åó„Å™„ÅÑ
            }
        }

        async function showSearchDialog() {
            const dialog = document.getElementById('search-dialog');
            const input = document.getElementById('search-input');
            
            dialog.style.display = 'flex';
            input.value = '';
            input.focus();
            
            // Wait for user action
            const result = await new Promise((resolve) => {
                const cancelBtn = document.getElementById('search-cancel-btn');
                
                const closeDialog = () => {
                    dialog.style.display = 'none';
                    resolve(null);
                };
                
                cancelBtn.onclick = closeDialog;
                
                input.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        const query = input.value.trim();
                        if (query) {
                            dialog.style.display = 'none';
                            resolve({query: query, searchType: 'web'});
                        }
                    }
                };
                
                // Click outside to close
                dialog.onclick = (e) => {
                    if (e.target === dialog) {
                        closeDialog();
                    }
                };
            });
            
            if (!result) return;
            
            const query = result.query;
            const resultSearchType = result.searchType;
            
            // Auto-add "web" to queries containing app names
            const appKeywords = ['youtube', 'facebook', 'instagram', 'twitter', 'tiktok', 'x.com'];
            let modifiedQuery = query;
            
            if (resultSearchType === 'web') {
                const queryLower = query.toLowerCase();
                const hasAppKeyword = appKeywords.some(keyword => queryLower.includes(keyword));
                const hasWebKeyword = queryLower.includes('web');
                
                // Add "web" if query contains app name but doesn't already have "web"
                if (hasAppKeyword && !hasWebKeyword) {
                    modifiedQuery = query + ' web';
                }
            }
            
            const searchIcon = resultSearchType === 'image' ? 'üñºÔ∏è' : 'üîç';

            addMessage('user', `${searchIcon} Ê§úÁ¥¢: ${query}`);

            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query: modifiedQuery,
                        session_id: sessionId,
                        search_type: resultSearchType
                    })
                });

                const data = await response.json();
                sessionId = data.session_id;
                
                // Build simple card-based search results (not in message bubble)
                const chatArea = document.getElementById('chatArea');
                
                // Add search results title
                const titleDiv = document.createElement('div');
                titleDiv.style.cssText = 'font-weight: 600; font-size: 16px; margin: 24px 0 16px 0; padding: 0 16px; color: #202124;';
                titleDiv.textContent = `${searchIcon} Ê§úÁ¥¢ÁµêÊûú: ${query}`;
                titleDiv.id = 'search-results-title';
                chatArea.appendChild(titleDiv);
                
                // Blocklist of domains to exclude
                const blockedDomains = ['anatoliystoneproducts.com'];
                
                if (data.results && data.results.length > 0) {
                    // Filter out blocked domains
                    const filteredResults = data.results.filter(r => {
                        try {
                            const url = new URL(r.link);
                            return !blockedDomains.some(domain => url.hostname.includes(domain));
                        } catch (e) {
                            return true; // Keep if URL parsing fails
                        }
                    });
                    
                    // Web search results - card layout
                    filteredResults.forEach((r, i) => {
                            const cardDiv = document.createElement('div');
                            cardDiv.style.cssText = 'margin: 0 16px 16px 16px; padding: 16px; background: #ffffff; border: 1px solid #e8eaed; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative;';
                            
                            cardDiv.innerHTML = `
                                <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 8px;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">
                                            <a href="${r.link}" target="_blank" style="color: #1a0dab; text-decoration: none;">
                                                ${i + 1}. ${r.title}
                                            </a>
                                        </div>
                                        <div style="color: #5f6368; font-size: 14px; margin-bottom: 8px; line-height: 1.6;">
                                            ${r.snippet}
                                        </div>
                                        <div style="color: #006621; font-size: 13px; word-break: break-all;">
                                            ${r.link}
                                        </div>
                                    </div>
                                    <button class="bookmark-btn" data-title="${r.title.replace(/"/g, '&quot;')}" data-url="${r.link}" style="background: none; border: none; cursor: pointer; font-size: 20px; color: #5f6368; padding: 0; margin-top: 2px;" title="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´ËøΩÂä†">‚ô°</button>
                                </div>
                            `;
                            
                            chatArea.appendChild(cardDiv);
                    });
                } else {
                    const noResultDiv = document.createElement('div');
                    noResultDiv.style.cssText = 'color: #888; padding: 20px; text-align: center; margin: 0 16px;';
                    noResultDiv.textContent = 'Ê§úÁ¥¢ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ';
                    chatArea.appendChild(noResultDiv);
                }
                
                // Scroll to the search results title
                const searchResultsTitle = document.getElementById('search-results-title');
                if (searchResultsTitle) {
                    searchResultsTitle.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                // Auto-trigger AI analysis of search results
                if (data.results && data.results.length > 0) {
                    // Add "AI analyzing..." message
                    const analyzingDiv = document.createElement('div');
                    analyzingDiv.id = 'ai-analyzing';
                    analyzingDiv.style.cssText = 'margin: 16px; padding: 16px; background: #f0f7ff; border: 1px solid #0063B2; border-radius: 8px; color: #0063B2; font-size: 14px;';
                    analyzingDiv.innerHTML = 'ü§ñ AI„ÅåÊ§úÁ¥¢ÁµêÊûú„ÇíÂàÜÊûê‰∏≠...';
                    chatArea.appendChild(analyzingDiv);
                    // Scroll to the search results title
                const searchResultsTitle = document.getElementById('search-results-title');
                if (searchResultsTitle) {
                    searchResultsTitle.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                    
                    try {
                        const analysisResponse = await fetch('/api/search/analyze', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                query: query,
                                results: data.results,
                                session_id: sessionId,
                                search_type: searchType
                            })
                        });
                        
                        const analysisData = await analysisResponse.json();
                        sessionId = analysisData.session_id;
                        
                        // Remove "analyzing" message
                        chatArea.removeChild(analyzingDiv);
                        
                        // Add AI analysis as assistant message
                        addMessage('assistant', `ü§ñ **AIÂàÜÊûê**\n\n${analysisData.analysis}`);
                        
                    } catch (error) {
                        console.error('AI analysis error:', error);
                        // Just remove the analyzing message without showing error
                        if (chatArea.contains(analyzingDiv)) {
                            chatArea.removeChild(analyzingDiv);
                        }
                    }
                }
            } catch (error) {
                console.error('Search error:', error);
                // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„Åó„Å™„ÅÑ
            }
            
            // History stack removed - using full page reload
        }

        function clearChat() {
            if (confirm('„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
                document.getElementById('chatArea').innerHTML = '';
                sessionId = null;
            }
        }

        // Shortcut functions
        function addBookmark(title, url) {
            const bookmarks = JSON.parse(localStorage.getItem('oreza_bookmarks') || '[]');
            
            // Check if already bookmarked
            const exists = bookmarks.some(b => b.url === url);
            if (exists) {
                return;
            }
            
            bookmarks.unshift({
                title: title,
                url: url,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 100 bookmarks
            if (bookmarks.length > 100) {
                bookmarks.pop();
            }
            
            localStorage.setItem('oreza_bookmarks', JSON.stringify(bookmarks));
        }
        
        
        // Tab management functions
        async function addTab(title, url) {
            console.log('[addTab] Called with:', { title, url });
            const tabs = JSON.parse(localStorage.getItem('oreza_tabs') || '[]');
            console.log('[addTab] Current tabs count:', tabs.length);
            
            // Remove duplicate if exists
            const filtered = tabs.filter(t => t.url !== url);
            
            // Fetch OG image in background
            let ogImage = null;
            try {
                const response = await fetch('/api/og-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                });
                const data = await response.json();
                ogImage = data.og_image;
            } catch (e) {
                console.log('Failed to fetch OG image:', e);
            }
            
            filtered.unshift({
                title: title,
                url: url,
                timestamp: new Date().toISOString(),
                favicon: `https://www.google.com/s2/favicons?domain=${new URL(url).hostname}&sz=64`,
                ogImage: ogImage
            });
            
            // Keep only last 50 tabs
            if (filtered.length > 50) {
                filtered.pop();
            }
            
            console.log('[addTab] Saving tabs, new count:', filtered.length);
            localStorage.setItem('oreza_tabs', JSON.stringify(filtered));
            console.log('[addTab] Tabs saved successfully');
        }
        
        function showTabs() {
            const tabs = JSON.parse(localStorage.getItem('oreza_tabs') || '[]');
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '';
            
            if (tabs.length === 0) {
                addMessage('assistant', '„Çø„Éñ„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            // Title with count and clear all button
            const titleDiv = document.createElement('div');
            titleDiv.style.cssText = 'font-weight: 600; font-size: 18px; margin: 16px 16px 16px 16px; color: #202124; display: flex; justify-content: space-between; align-items: center;';
            titleDiv.innerHTML = `
                <span>„Çø„Éñ (${tabs.length})</span>
                <button onclick="clearAllTabs()" style="background: none; border: none; cursor: pointer; font-size: 24px; color: #5f6368; padding: 0;" title="ÂÖ®„Å¶Èñâ„Åò„Çã">√ó</button>
            `;
            chatArea.appendChild(titleDiv);
            
            // Display tabs as cards
            tabs.forEach((tab, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.style.cssText = 'margin: 0 16px 16px 16px; padding: 16px; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); cursor: pointer; transition: box-shadow 0.2s; position: relative;';
                cardDiv.onmouseenter = () => cardDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                cardDiv.onmouseleave = () => cardDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.08)';
                
                const date = new Date(tab.timestamp);
                const dateStr = `${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                // Extract domain from URL
                let domain = '';
                try {
                    domain = new URL(tab.url).hostname.replace('www.', '');
                } catch (e) {
                    domain = tab.url;
                }
                
                // Build horizontal card with OG image on the left
                let previewHTML = '';
                if (tab.ogImage) {
                    previewHTML = `
                        <div style="width: 120px; height: 80px; overflow: hidden; border-radius: 8px; flex-shrink: 0; background: #f5f5f5;">
                            <img src="${tab.ogImage}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.style.display='none'">
                        </div>
                    `;
                }
                
                // Get favicon URL (with fallback for old data)
                const faviconUrl = tab.favicon || `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
                
                cardDiv.innerHTML = `
                    <div style="display: flex; gap: 12px; align-items: center;">
                        ${previewHTML}
                        <div style="display: flex; gap: 12px; align-items: center; flex: 1; min-width: 0;">
                            <img src="${faviconUrl}" style="width: 24px; height: 24px; flex-shrink: 0; border-radius: 4px;" onerror="this.style.display='none'" alt="favicon">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: 14px; color: #202124; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    <span class="tab-title" data-index="${index}" style="display: inline;">${tab.title}</span>
                                </div>
                                <div style="font-size: 12px; color: #5f6368; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${domain}
                                </div>
                                <div style="font-size: 11px; color: #888; margin-top: 2px;">
                                    ${dateStr}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center; flex-shrink: 0;">
                                <button class="edit-tab-title-btn" data-index="${index}" style="background: none; border: none; cursor: pointer; font-size: 16px; color: #5f6368; padding: 2px;" title="„Çø„Ç§„Éà„É´„ÇíÁ∑®ÈõÜ">‚ãØ</button>
                                <button class="delete-tab-btn" style="background: none; border: none; cursor: pointer; font-size: 24px; color: #5f6368; padding: 0;" title="ÂâäÈô§">√ó</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Edit title button
                const editBtn = cardDiv.querySelector('.edit-tab-title-btn');
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    const newTitle = prompt('Êñ∞„Åó„ÅÑ„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', tab.title);
                    if (newTitle && newTitle.trim()) {
                        editTabTitle(index, newTitle.trim());
                        showTabs(); // Refresh display
                    }
                };
                
                // Click to open URL
                cardDiv.onclick = (e) => {
                    if (!e.target.classList.contains('delete-tab-btn') && !e.target.classList.contains('edit-tab-title-btn')) {
                        window.open(tab.url, '_blank');
                    }
                };
                
                // Delete button
                const deleteBtn = cardDiv.querySelector('.delete-tab-btn');
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteTab(index);
                    showTabs(); // Refresh display
                };
                
                chatArea.appendChild(cardDiv);
            });
        }
        
        function deleteTab(index) {
            const tabs = JSON.parse(localStorage.getItem('oreza_tabs') || '[]');
            tabs.splice(index, 1);
            localStorage.setItem('oreza_tabs', JSON.stringify(tabs));
        }
        
        function clearAllTabs() {
            if (confirm('ÂÖ®„Å¶„ÅÆ„Çø„Éñ„ÇíÈñâ„Åò„Åæ„Åô„ÅãÔºü')) {
                localStorage.setItem('oreza_tabs', '[]');
                const chatArea = document.getElementById('chatArea');
                chatArea.innerHTML = '';
                addMessage('assistant', 'ÂÖ®„Å¶„ÅÆ„Çø„Éñ„ÇíÈñâ„Åò„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        function editTabTitle(index, newTitle) {
            const tabs = JSON.parse(localStorage.getItem('oreza_tabs') || '[]');
            if (tabs[index]) {
                tabs[index].title = newTitle;
                localStorage.setItem('oreza_tabs', JSON.stringify(tabs));
            }
        }
                function deleteTab(index) {
            const bookmarks = JSON.parse(localStorage.getItem('oreza_bookmarks') || '[]');
            if (bookmarks.length === 0) {
                addMessage('assistant', '„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÅØ„Åæ„Å†ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÊ§úÁ¥¢ÁµêÊûú„ÅÆ‚ô°„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´ËøΩÂä†„Åß„Åç„Åæ„Åô„ÄÇ');
                return;
            }
            
            const chatArea = document.getElementById('chatArea');
            
            // Check if bookmarks are already displayed
            const existingTitle = chatArea.querySelector('[data-section="bookmarks"]');
            if (existingTitle) {
                return; // Already displayed, do nothing
            }
            
            const titleDiv = document.createElement('div');
            titleDiv.setAttribute('data-section', 'bookmarks');
            titleDiv.style.cssText = 'font-weight: 600; font-size: 16px; margin: 24px 0 16px 0; padding: 0 16px; color: #202124;';
            titleDiv.textContent = '„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ‰∏ÄË¶ß';
            chatArea.appendChild(titleDiv);
            
            bookmarks.forEach((bookmark, i) => {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'margin: 0 16px 12px 16px; padding: 12px; background: #ffffff; border: 1px solid #e8eaed; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;';
                
                const linkDiv = document.createElement('div');
                linkDiv.style.cssText = 'flex: 1; overflow: hidden;';
                
                const link = document.createElement('a');
                link.href = bookmark.url;
                link.target = '_blank';
                link.style.cssText = 'color: #1a73e8; text-decoration: none; font-size: 15px;';
                link.textContent = `${i + 1}. ${bookmark.title}`;
                linkDiv.appendChild(link);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '√ó';
                deleteBtn.style.cssText = 'background: none; border: none; cursor: pointer; font-size: 20px; padding: 4px 8px; margin-left: 8px; color: #5f6368;';
                deleteBtn.title = 'ÂâäÈô§';
                deleteBtn.onclick = () => {
                    const bookmarks = JSON.parse(localStorage.getItem('oreza_bookmarks') || '[]');
                    const filtered = bookmarks.filter(b => b.url !== bookmark.url);
                    localStorage.setItem('oreza_bookmarks', JSON.stringify(filtered));
                    itemDiv.remove();
                };
                
                itemDiv.appendChild(linkDiv);
                itemDiv.appendChild(deleteBtn);
                chatArea.appendChild(itemDiv);
            });
        }
        
        function showReadingList() {
            const readingList = JSON.parse(localStorage.getItem('oreza_reading_list') || '[]');
            if (readingList.length === 0) {
                addMessage('assistant', '„É™„Éº„Éá„Ç£„É≥„Ç∞„É™„Çπ„Éà„ÅØ„Åæ„Å†ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            let message = 'üìù **„É™„Éº„Éá„Ç£„É≥„Ç∞„É™„Çπ„Éà**\n\n';
            readingList.forEach((item, i) => {
                message += `${i + 1}. [${item.title}](${item.url})\n`;
            });
            addMessage('assistant', message);
        }
        
        function showRecentTabs() {
            const recentTabs = JSON.parse(localStorage.getItem('oreza_recent_tabs') || '[]');
            if (recentTabs.length === 0) {
                addMessage('assistant', 'ÊúÄËøë‰Ωø„Å£„Åü„Çø„Éñ„ÅÆÂ±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            let message = 'üì± **ÊúÄËøë‰Ωø„Å£„Åü„Çø„Éñ**\n\n';
            recentTabs.slice(0, 10).forEach((tab, i) => {
                message += `${i + 1}. [${tab.title}](${tab.url})\n`;
            });
            addMessage('assistant', message);
        }
        
        function showHistory() {
            // Use historyStack instead of localStorage
            if (historyStack.length === 0) {
                addMessage('assistant', 'Â±•Ê≠¥„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = ''; // Clear chat area
            
            // Title with count (Chrome-style)
            const titleDiv = document.createElement('div');
            titleDiv.style.cssText = 'font-weight: 600; font-size: 18px; margin: 16px 16px 24px 16px; color: #202124; display: flex; justify-content: space-between; align-items: center;';
            titleDiv.innerHTML = `
                <span>Â±•Ê≠¥ (${historyStack.length})</span>
                <button onclick="clearAllHistory()" style="background: none; border: none; cursor: pointer; font-size: 24px; color: #5f6368; padding: 0;" title="ÂÖ®„Å¶ÂâäÈô§">√ó</button>
            `;
            chatArea.appendChild(titleDiv);
            
            // Display history as Chrome-style tab cards (reversed order - newest first)
            const reversedHistory = [...historyStack].reverse();
            reversedHistory.forEach((item, i) => {
                const actualIndex = historyStack.length - 1 - i; // Actual index in historyStack
                
                // Determine icon based on type
                let icon = 'üìù';
                let title = 'Unknown';
                let subtitle = '';
                
                switch(item.type) {
                    case 'search':
                        icon = 'üîç';
                        title = item.data.query || 'Search';
                        subtitle = `${item.data.results?.length || 0}‰ª∂„ÅÆÁµêÊûú`;
                        break;
                    case 'chat':
                        icon = 'üí¨';
                        const lastMsg = item.data.messages?.[item.data.messages.length - 1];
                        title = lastMsg?.content?.substring(0, 30) || 'Chat';
                        subtitle = `${item.data.messages?.length || 0}‰ª∂„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏`;
                        break;
                    case 'url_preview':
                        icon = 'üîó';
                        title = item.data.title || 'URL';
                        subtitle = item.data.url;
                        break;
                    case 'bookmark':
                        icon = '‚ù§Ô∏è';
                        title = 'Bookmarks';
                        break;
                    case 'home':
                        icon = 'üè†';
                        title = 'Home';
                        break;
                }
                
                const date = new Date(item.timestamp).toLocaleString('ja-JP', { 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // Chrome-style tab card
                const cardDiv = document.createElement('div');
                cardDiv.style.cssText = 'margin: 0 16px 16px 16px; padding: 16px; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); cursor: pointer; transition: all 0.2s; position: relative;';
                cardDiv.onmouseover = () => cardDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                cardDiv.onmouseout = () => cardDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.08)';
                
                cardDiv.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="font-size: 24px; flex-shrink: 0;">${icon}</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 15px; color: #202124; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${title}
                            </div>
                            <div style="font-size: 13px; color: #5f6368; margin-bottom: 6px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${subtitle}
                            </div>
                            <div style="font-size: 12px; color: #888;">
                                ${date}
                            </div>
                        </div>
                        <button class="delete-history-btn" data-index="${actualIndex}" style="background: none; border: none; cursor: pointer; font-size: 20px; color: #5f6368; padding: 4px; flex-shrink: 0;" title="ÂâäÈô§">√ó</button>
                    </div>
                `;
                
                // Click to restore view
                cardDiv.onclick = (e) => {
                    if (!e.target.classList.contains('delete-history-btn')) {
                        historyIndex = actualIndex;
                        restoreView(item.type, item.data);
                        updateNavigationButtons();
                    }
                };
                
                // Delete button
                const deleteBtn = cardDiv.querySelector('.delete-history-btn');
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteHistoryItem(actualIndex);
                    cardDiv.remove();
                    // Update title count
                    titleDiv.querySelector('span').textContent = `Â±•Ê≠¥ (${historyStack.length})`;
                };
                
                chatArea.appendChild(cardDiv);
            });
        }
        
        function deleteHistoryItem(index) {
            historyStack.splice(index, 1);
            
            // Adjust historyIndex if needed
            if (historyIndex >= index) {
                historyIndex = Math.max(0, historyIndex - 1);
            }
            
            updateNavigationButtons();
            console.log('History item deleted at index:', index, 'New stack size:', historyStack.length);
        }
        
        function clearAllHistory() {
            if (confirm('ÂÖ®„Å¶„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                historyStack = [];
                historyIndex = -1;
                const chatArea = document.getElementById('chatArea');
                chatArea.innerHTML = '';
                addMessage('assistant', 'Â±•Ê≠¥„ÇíÂÖ®„Å¶ÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ');
                updateNavigationButtons();
                console.log('All history cleared');
            }
        }

        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Èü≥Â£∞ÂÖ•Âäõ„ÅØ„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„Åß„ÅØ„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                document.getElementById('messageInput').value = text;
            };
            recognition.start();
        }

        // Helper function to convert URLs and markdown links to clickable links
        function convertLinksToHTML(text) {
            // Convert markdown links [text](url) to HTML links
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2"  style="color: #1a73e8; text-decoration: none;">$1</a>');
            
            // Convert plain URLs to HTML links
            text = text.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1"  style="color: #1a73e8; text-decoration: none;">$1</a>');
            
            // Convert **text** to bold (markdown bold)
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Preserve line breaks
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }

        // Helper function to add copy button
        function addCopyButton(messageDiv, contentDiv) {
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            `;
            copyBtn.title = '„Ç≥„Éî„Éº';
            copyBtn.onclick = () => {
                const textContent = contentDiv.textContent || contentDiv.innerText;
                navigator.clipboard.writeText(textContent).then(() => {
                    copyBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    `;
                    setTimeout(() => {
                        copyBtn.innerHTML = `
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        `;
                    }, 2000);
                });
            };
            messageDiv.appendChild(copyBtn);
        }

        function addMessage(role, content, imageUrl = null, isHTML = false, animate = false) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? userAvatar : aiAvatar;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // If image URL is provided, display the image
            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.style.maxWidth = '300px';
                img.style.maxHeight = '300px';
                img.style.borderRadius = '12px';
                img.style.marginBottom = '8px';
                img.style.display = 'block';
                contentDiv.appendChild(img);
                
                // Add text if provided
                if (content) {
                    const textDiv = document.createElement('div');
                    if (isHTML) {
                        textDiv.innerHTML = content;
                    } else {
                        textDiv.textContent = content;
                    }
                    contentDiv.appendChild(textDiv);
                }
            } else {
                // If HTML content, use innerHTML (no animation)
                if (isHTML) {
                    contentDiv.innerHTML = content;
                } else if (animate && role === 'assistant') {
                    // Typing animation for AI messages
                    contentDiv.textContent = '';
                    messageDiv.appendChild(avatar);
                    messageDiv.appendChild(contentDiv);
                    chatArea.appendChild(messageDiv);
                    
                    let index = 0;
                    const typingSpeed = 30; // milliseconds per character
                    
                    function typeCharacter() {
                        if (index < content.length) {
                            contentDiv.textContent += content.charAt(index);
                            index++;
                            // Scroll to the search results title
                const searchResultsTitle = document.getElementById('search-results-title');
                if (searchResultsTitle) {
                    searchResultsTitle.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                            setTimeout(typeCharacter, typingSpeed);
                        } else {
                            // Convert links after typing animation completes
                            const htmlContent = convertLinksToHTML(contentDiv.textContent);
                            contentDiv.innerHTML = htmlContent;
                            
                            // Add copy button after typing animation completes
                            addCopyButton(messageDiv, contentDiv);
                        }
                    }
                    
                    typeCharacter();
                    return; // Early return to avoid appending twice
                } else {
                    // Convert links for non-animated messages
                    const htmlContent = convertLinksToHTML(content);
                    contentDiv.innerHTML = htmlContent;
                }
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            
            // Add copy button for assistant messages (including search results)
            if (role === 'assistant' && !messageDiv.classList.contains('thinking-indicator')) {
                addCopyButton(messageDiv, contentDiv);
            }
            
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // ========== Connection Management ==========
        
        // Keep-Alive mechanism
        function startKeepAlive() {
            if (keepAliveInterval) {
                clearInterval(keepAliveInterval);
            }
            
            keepAliveInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/ping', { 
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'}
                    });
                    
                    if (response.ok) {
                        if (connectionStatus !== 'connected') {
                            connectionStatus = 'connected';
                            reconnectAttempts = 0;
                            updateConnectionStatus();
                        }
                    } else {
                        handleConnectionError();
                    }
                } catch (error) {
                    console.warn('Keep-alive ping failed:', error);
                    handleConnectionError();
                }
            }, KEEP_ALIVE_INTERVAL);
        }
        
        function stopKeepAlive() {
            if (keepAliveInterval) {
                clearInterval(keepAliveInterval);
                keepAliveInterval = null;
            }
        }
        
        // Handle connection error
        function handleConnectionError() {
            if (connectionStatus === 'connected') {
                connectionStatus = 'reconnecting';
                reconnectAttempts = 0;
                updateConnectionStatus();
                attemptReconnect();
            }
        }
        
        // Attempt to reconnect with exponential backoff (faster, background mode)
        function attemptReconnect() {
            if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                connectionStatus = 'disconnected';
                updateConnectionStatus();
                return;
            }
            
            reconnectAttempts++;
            // Faster reconnection: 500ms, 1s, 2s, 4s, 8s (instead of 2s, 4s, 8s, 16s, 32s)
            const delay = Math.min(Math.pow(2, reconnectAttempts - 1) * 500, 8000);
            
            setTimeout(async () => {
                try {
                    const response = await fetch('/api/ping', { 
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'}
                    });
                    
                    if (response.ok) {
                        connectionStatus = 'connected';
                        reconnectAttempts = 0;
                        updateConnectionStatus();
                    } else {
                        attemptReconnect();
                    }
                } catch (error) {
                    console.warn(`Reconnect attempt ${reconnectAttempts} failed:`, error);
                    attemptReconnect();
                }
            }, delay);
        }
        
        // Fetch with retry (exponential backoff)
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    
                    if (response.ok) {
                        return response;
                    }
                    
                    // Handle rate limiting or service unavailable
                    if (response.status === 429 || response.status === 503) {
                        if (i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                    }
                    
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // Chat History, Bookmarks and Tabs Display Functions
        function showChatHistory() {
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '';
            
            // Add title
            const titleDiv = document.createElement('div');
            titleDiv.style.cssText = 'font-weight: 600; font-size: 18px; margin: 24px 16px 16px 16px; color: #202124;';
            titleDiv.textContent = 'üí¨ „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥';
            chatArea.appendChild(titleDiv);
            
            // Get chat history from localStorage
            const chatHistory = JSON.parse(localStorage.getItem('oreza_chat_history') || '[]');
            
            if (chatHistory.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.style.cssText = 'color: #888; padding: 20px; text-align: center; margin: 0 16px;';
                emptyDiv.textContent = '„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                chatArea.appendChild(emptyDiv);
                return;
            }
            
            // Display chat history (most recent first)
            chatHistory.slice().reverse().forEach((chat, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.style.cssText = 'margin: 0 16px 12px 16px; padding: 16px; background: #ffffff; border: 1px solid #e8eaed; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative;';
                
                cardDiv.innerHTML = `
                    <div style="font-weight: 600; font-size: 15px; margin-bottom: 8px; color: #202124;">
                        ${chat.query || chat.message}
                    </div>
                    <div style="color: #5f6368; font-size: 14px; line-height: 1.6; margin-bottom: 8px;">
                        ${chat.response ? chat.response.substring(0, 150) + (chat.response.length > 150 ? '...' : '') : ''}
                    </div>
                    <div style="color: #5f6368; font-size: 12px; margin-top: 8px;">
                        ${new Date(chat.timestamp).toLocaleString('ja-JP')}
                    </div>
                    <button class="remove-chat-btn" data-index="${chatHistory.length - 1 - index}" style="position: absolute; top: 16px; right: 16px; background: none; border: none; cursor: pointer; font-size: 18px; color: #d93025; padding: 0;" title="„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Åã„ÇâÂâäÈô§">√ó</button>
                `;
                
                chatArea.appendChild(cardDiv);
            });
            
            // Add event listeners for remove buttons
            document.querySelectorAll('.remove-chat-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    chatHistory.splice(index, 1);
                    localStorage.setItem('oreza_chat_history', JSON.stringify(chatHistory));
                    showChatHistory(); // Refresh display
                });
            });
        }
        
        // Global variables for music search persistence
        let globalMusicPlaylist = [];
        let globalMusicIndex = 0;
        let globalLastSearchQuery = '';
        
        function showMusicKit() {
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '';
            
            // Set white background
            chatArea.style.background = '#ffffff';
            
            // Add now playing section (large artwork)
            const nowPlayingDiv = document.createElement('div');
            nowPlayingDiv.id = 'now-playing-section';
            nowPlayingDiv.style.cssText = 'padding: 40px 20px; text-align: center; background: #ffffff; display: none;';
            nowPlayingDiv.innerHTML = `
                <img id="large-artwork" src="" alt="" style="width: 280px; height: 280px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); margin-bottom: 24px;">
                <div id="large-title" style="font-size: 22px; font-weight: 700; color: #000; margin-bottom: 8px;"></div>
                <div id="large-artist" style="font-size: 18px; color: #666; margin-bottom: 32px;"></div>
                <div style="display: flex; justify-content: center; align-items: center; gap: 32px;">
                    <button id="large-prev" style="background: none; border: none; color: #000; font-size: 56px; cursor: pointer; padding: 0; line-height: 1;">‚óÄÔ∏é</button>
                    <button id="large-play" style="background: none; border: none; color: #000; font-size: 56px; cursor: pointer; padding: 0; line-height: 1;">‚ñ∂Ô∏é</button>
                    <button id="large-next" style="background: none; border: none; color: #000; font-size: 56px; cursor: pointer; padding: 0; line-height: 1;">‚ñ∂Ô∏é</button>
                </div>
            `;
            chatArea.appendChild(nowPlayingDiv);
            
            // Add search box
            const searchDiv = document.createElement('div');
            searchDiv.style.cssText = 'padding: 20px; background: #ffffff; position: relative;';
            searchDiv.innerHTML = `
                <input type="text" id="music-search-input" placeholder="Êõ≤Âêç„ÄÅ„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÊ§úÁ¥¢" value="${globalLastSearchQuery}" style="width: 100%; padding: 14px 60px 14px 20px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; outline: none; background: #f9f9f9;">
                <button id="music-search-btn" style="position: absolute; right: 30px; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; border-radius: 50%; background: #999; border: none; color: white; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;">‚Üí</button>
            `;
            chatArea.appendChild(searchDiv);
            
            // Add results container
            const resultsDiv = document.createElement('div');
            resultsDiv.id = 'music-results';
            resultsDiv.style.cssText = 'padding: 0 20px 20px 20px; background: #ffffff;';
            chatArea.appendChild(resultsDiv);
            
            // Restore previous search results if available
            if (globalMusicPlaylist.length > 0) {
                displayMusicResults(globalMusicPlaylist);
            }
            
            // Add mini player at bottom (initially hidden)
            const playerDiv = document.createElement('div');
            playerDiv.id = 'music-player';
            playerDiv.style.cssText = 'position: fixed; bottom: 0; left: 0; right: 0; background: #ffffff; padding: 12px 16px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: none; z-index: 1000; border-top: 1px solid #e0e0e0;';
            playerDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <img id="player-artwork" src="" alt="" style="width: 48px; height: 48px; border-radius: 8px; display: none; cursor: pointer;" onclick="showLargePlayer()">
                    <div style="flex: 1; min-width: 0; cursor: pointer;" onclick="showLargePlayer()">
                        <div id="player-title" style="font-weight: 600; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #000;"></div>
                        <div id="player-artist" style="font-size: 12px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></div>
                    </div>
                    <div style="display: flex; gap: 16px; align-items: center;">
                        <button id="player-prev" style="background: none; border: none; color: #666; font-size: 28px; cursor: pointer; padding: 0;">‚óÄÔ∏é</button>
                        <button id="player-play" style="background: none; border: none; color: #000; font-size: 32px; cursor: pointer; padding: 0;">‚ñ∂Ô∏é</button>
                        <button id="player-next" style="background: none; border: none; color: #666; font-size: 28px; cursor: pointer; padding: 0;">‚ñ∂Ô∏é</button>
                        <button id="player-close" style="background: none; border: none; color: #999; font-size: 20px; cursor: pointer; padding: 0;">√ó</button>
                    </div>
                </div>
            `;
            document.body.appendChild(playerDiv);
            
            function displayMusicResults(results) {
                const resultsContainer = document.getElementById('music-results');
                resultsContainer.innerHTML = '';
                
                results.forEach((track, index) => {
                    const trackDiv = document.createElement('div');
                    trackDiv.style.cssText = 'margin-bottom: 12px; padding: 16px; background: #ffffff; border: 1px solid #e8eaed; border-radius: 12px; cursor: pointer; transition: all 0.2s;';
                    trackDiv.onmouseover = () => trackDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                    trackDiv.onmouseout = () => trackDiv.style.boxShadow = 'none';
                    
                    trackDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <img src="${track.artworkUrl100}" alt="" style="width: 80px; height: 80px; border-radius: 8px; flex-shrink: 0;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #000;">${track.trackName}</div>
                                <div style="color: #666; font-size: 14px; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${track.artistName}</div>
                                <div style="color: #999; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${track.collectionName}</div>
                            </div>
                            <button class="play-track-btn" data-index="${index}" style="background: #fa243c; color: white; border: none; width: 56px; height: 56px; border-radius: 50%; cursor: pointer; font-size: 20px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">‚ñ∑</button>
                        </div>
                    `;
                    
                    resultsContainer.appendChild(trackDiv);
                });
                
                // Add event listeners to play buttons
                document.querySelectorAll('.play-track-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const index = parseInt(btn.getAttribute('data-index'));
                        playTrack(index);
                    });
                });
            }
            
            async function searchMusic() {
                const query = document.getElementById('music-search-input').value.trim();
                if (!query) return;
                
                const resultsContainer = document.getElementById('music-results');
                resultsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">üîé Ê§úÁ¥¢‰∏≠...</div>';
                
                try {
                    // Use iTunes Search API (no authentication required) - increased to 100
                    const response = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=song&limit=100&country=JP`);
                    const data = await response.json();
                    
                    if (data.results && data.results.length > 0) {
                        // Save to global variables
                        globalMusicPlaylist = data.results;
                        globalLastSearchQuery = query;
                        
                        displayMusicResults(data.results);
                    } else {
                        resultsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Ê§úÁ¥¢ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div>';
                    }
                } catch (error) {
                    console.error('Music search error:', error);
                    // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„Åó„Å™„ÅÑ
                }
            }
            
            function playTrack(index) {
                globalMusicIndex = index;
                const track = globalMusicPlaylist[index];
                
                // Update mini player UI
                const player = document.getElementById('music-player');
                const artwork = document.getElementById('player-artwork');
                const title = document.getElementById('player-title');
                const artist = document.getElementById('player-artist');
                
                artwork.src = track.artworkUrl100;
                artwork.style.display = 'block';
                title.textContent = track.trackName;
                artist.textContent = track.artistName;
                player.style.display = 'block';
                
                // Update large player UI
                const largeArtwork = document.getElementById('large-artwork');
                const largeTitle = document.getElementById('large-title');
                const largeArtist = document.getElementById('large-artist');
                
                largeArtwork.src = track.artworkUrl100.replace('100x100', '600x600');
                largeTitle.textContent = track.trackName;
                largeArtist.textContent = track.artistName;
                
                // Create audio element if not exists
                let audio = document.getElementById('music-audio');
                if (!audio) {
                    audio = document.createElement('audio');
                    audio.id = 'music-audio';
                    document.body.appendChild(audio);
                }
                
                // Play preview (30 seconds)
                if (track.previewUrl) {
                    audio.src = track.previewUrl;
                    const playPromise = audio.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            // Playback started successfully
                            document.getElementById('player-play').textContent = '‚óΩÔ∏è';
                            document.getElementById('large-play').textContent = '‚óΩÔ∏è';
                            console.log('Music playing:', track.trackName);
                        }).catch(error => {
                            // Auto-play was prevented
                            console.error('Playback error:', error);
                            alert('Èü≥Ê•Ω„ÅÆÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÂÜçÁîü„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        });
                    }
                    
                    // Auto-save played music to Tabs
                    const musicUrl = `https://music.apple.com/jp/album/${track.collectionId}?i=${track.trackId}`;
                    const musicTitle = `üéµ ${track.trackName} - ${track.artistName}`;
                    
                    // Use addTab function to save to tabs
                    addTab(musicTitle, musicUrl);
                } else {
                    alert('„Åì„ÅÆÊõ≤„ÅÆ„Éó„É¨„Éì„É•„Éº„ÅØÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
                }
            }
            
            // Show large player function
            window.showLargePlayer = function() {
                document.getElementById('now-playing-section').style.display = 'block';
                document.getElementById('music-results').style.display = 'none';
                document.querySelector('#music-search-input').parentElement.style.display = 'none';
            }
            
            // Hide large player function
            window.hideLargePlayer = function() {
                document.getElementById('now-playing-section').style.display = 'none';
                document.getElementById('music-results').style.display = 'block';
                document.querySelector('#music-search-input').parentElement.style.display = 'block';
            }
            
            // Event listeners
            document.getElementById('music-search-input').onkeydown = (e) => {
                if (e.key === 'Enter') searchMusic();
            };
            
            document.getElementById('music-search-btn').onclick = () => {
                searchMusic();
            };
            
            document.getElementById('player-play').onclick = () => {
                const audio = document.getElementById('music-audio');
                if (audio) {
                    if (audio.paused) {
                        audio.play();
                        document.getElementById('player-play').textContent = '‚óΩÔ∏è';
                        if (document.getElementById('large-play')) {
                            document.getElementById('large-play').textContent = '‚óΩÔ∏è';
                        }
                    } else {
                        audio.pause();
                        document.getElementById('player-play').textContent = '‚ñ∂Ô∏é';
                        if (document.getElementById('large-play')) {
                            document.getElementById('large-play').textContent = '‚ñ∂Ô∏é';
                        }
                    }
                }
            };
            
            document.getElementById('player-prev').onclick = () => {
                if (globalMusicIndex > 0) {
                    playTrack(globalMusicIndex - 1);
                }
            };
            
            document.getElementById('player-next').onclick = () => {
                if (globalMusicIndex < globalMusicPlaylist.length - 1) {
                    playTrack(globalMusicIndex + 1);
                }
            };
            
            document.getElementById('player-close').onclick = () => {
                const audio = document.getElementById('music-audio');
                if (audio) {
                    audio.pause();
                }
                document.getElementById('music-player').style.display = 'none';
                hideLargePlayer();
            };
            
            // Large player controls
            document.getElementById('large-play').onclick = () => {
                const audio = document.getElementById('music-audio');
                if (audio) {
                    if (audio.paused) {
                        audio.play();
                        document.getElementById('large-play').textContent = '‚óΩÔ∏è';
                        document.getElementById('player-play').textContent = '‚óΩÔ∏è';
                    } else {
                        audio.pause();
                        document.getElementById('large-play').textContent = '‚ñ∂Ô∏é';
                        document.getElementById('player-play').textContent = '‚ñ∂Ô∏é';
                    }
                }
            };
            
            document.getElementById('large-prev').onclick = () => {
                if (globalMusicIndex > 0) {
                    playTrack(globalMusicIndex - 1);
                }
            };
            
            document.getElementById('large-next').onclick = () => {
                if (globalMusicIndex < globalMusicPlaylist.length - 1) {
                    playTrack(globalMusicIndex + 1);
                }
            };
        }
        
        function showBookmarks() {
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '';
            
            // Add title
            const titleDiv = document.createElement('div');
            titleDiv.style.cssText = 'font-weight: 600; font-size: 18px; margin: 24px 16px 16px 16px; color: #202124;';
            titleDiv.textContent = 'üìö „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥';
            chatArea.appendChild(titleDiv);
            
            // Get bookmarks from localStorage
            const allBookmarks = JSON.parse(localStorage.getItem('oreza_bookmarks') || '[]');
            
            // Filter out Apple Music links
            const bookmarks = allBookmarks.filter(bookmark => {
                return !bookmark.url.includes('music.apple.com');
            });
            
            if (bookmarks.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.style.cssText = 'color: #888; padding: 20px; text-align: center; margin: 0 16px;';
                emptyDiv.textContent = '„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                chatArea.appendChild(emptyDiv);
                return;
            }
            
            // Grid container for thumbnails (iOS app style)
            const gridContainer = document.createElement('div');
            gridContainer.style.cssText = 'display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px 16px; padding: 0 20px; margin-bottom: 16px;';
            
            // Display bookmarks (most recent first)
            bookmarks.slice().reverse().forEach(async (bookmark, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'bookmark-item';
                cardDiv.draggable = true;
                cardDiv.dataset.bookmarkIndex = bookmarks.length - 1 - index;
                cardDiv.style.cssText = 'display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;';
                
                // For non-Apple Music links, show favicon or generic icon (iOS app style)
                try {
                    const url = new URL(bookmark.url);
                    const faviconUrl = `https://www.google.com/s2/favicons?domain=${url.hostname}&sz=128`;
                    
                    cardDiv.innerHTML = `
                        <div style="position: relative; width: 100%; aspect-ratio: 1;">
                            <div style="width: 100%; height: 100%; background: white; border-radius: 22%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                                <img src="${faviconUrl}" style="width: 70%; height: 70%; object-fit: contain; pointer-events: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" alt="favicon">
                                <div style="display: none; font-size: 36px; align-items: center; justify-content: center; pointer-events: none;">üîó</div>
                            </div>
                            <button class="remove-bookmark-btn" data-index="${bookmarks.length - 1 - index}" style="position: absolute; top: -6px; left: -6px; background: rgba(0,0,0,0.6); border: none; cursor: pointer; font-size: 18px; color: #fff; width: 24px; height: 24px; border-radius: 50%; display: none; align-items: center; justify-content: center; z-index: 10;" title="„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Åã„ÇâÂâäÈô§">√ó</button>
                        </div>
                        <div style="margin-top: 6px; color: #000; font-size: 11px; font-weight: 400; line-height: 1.2; text-align: center; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; max-width: 100%; word-break: break-word; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;">
                            ${bookmark.title.length > 20 ? bookmark.title.substring(0, 20) + '...' : bookmark.title}
                        </div>
                    `;
                } catch (error) {
                    cardDiv.innerHTML = `
                        <div style="position: relative; width: 100%; aspect-ratio: 1;">
                            <div style="width: 100%; height: 100%; background: white; border-radius: 22%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 36px; pointer-events: none;">
                                üîó
                            </div>
                            <button class="remove-bookmark-btn" data-index="${bookmarks.length - 1 - index}" style="position: absolute; top: -6px; left: -6px; background: rgba(0,0,0,0.6); border: none; cursor: pointer; font-size: 18px; color: #fff; width: 24px; height: 24px; border-radius: 50%; display: none; align-items: center; justify-content: center; z-index: 10;" title="„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Åã„ÇâÂâäÈô§">√ó</button>
                        </div>
                        <div style="margin-top: 6px; color: #000; font-size: 11px; font-weight: 400; line-height: 1.2; text-align: center; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; max-width: 100%; word-break: break-word;">
                            ${bookmark.title.length > 20 ? bookmark.title.substring(0, 20) + '...' : bookmark.title}
                        </div>
                    `;
                }
                
                // Click to open URL
                cardDiv.onclick = (e) => {
                    if (!e.target.classList.contains('remove-bookmark-btn')) {
                        window.open(bookmark.url, '_self');
                    }
                };
                
                gridContainer.appendChild(cardDiv);
            });
            
            chatArea.appendChild(gridContainer);
            
            // Add long press to show delete buttons (iOS style)
            let longPressTimer;
            let isEditMode = false;
            let draggedElement = null;
            
            document.querySelectorAll('.bookmark-item').forEach(item => {
                // Long press detection
                item.addEventListener('touchstart', (e) => {
                    longPressTimer = setTimeout(() => {
                        isEditMode = true;
                        document.querySelectorAll('.remove-bookmark-btn').forEach(btn => {
                            btn.style.display = 'flex';
                        });
                        // Add wiggle animation
                        document.querySelectorAll('.bookmark-item').forEach(i => {
                            i.style.animation = 'wiggle 0.3s ease-in-out infinite';
                        });
                    }, 500);
                });
                
                // Prevent context menu on long press
                item.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    return false;
                });
                
                item.addEventListener('touchend', () => {
                    clearTimeout(longPressTimer);
                });
                
                item.addEventListener('touchmove', () => {
                    clearTimeout(longPressTimer);
                });
                
                // Drag and drop for reordering
                item.addEventListener('dragstart', (e) => {
                    if (!isEditMode) return;
                    draggedElement = e.target;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', e.target.dataset.bookmarkIndex);
                    setTimeout(() => {
                        e.target.style.opacity = '0.4';
                    }, 0);
                });
                
                item.addEventListener('dragend', (e) => {
                    e.target.style.opacity = '1';
                    draggedElement = null;
                });
                
                item.addEventListener('dragover', (e) => {
                    if (!isEditMode || !draggedElement) return;
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    
                    const afterElement = getDragAfterElement(gridContainer, e.clientY);
                    if (afterElement == null) {
                        gridContainer.appendChild(draggedElement);
                    } else {
                        gridContainer.insertBefore(draggedElement, afterElement);
                    }
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (!isEditMode || !draggedElement) return;
                    
                    // Get new order from DOM
                    const items = Array.from(gridContainer.querySelectorAll('.bookmark-item'));
                    const newOrder = items.map(item => parseInt(item.dataset.bookmarkIndex));
                    
                    // Reorder bookmarks in localStorage
                    const allBookmarks = JSON.parse(localStorage.getItem('oreza_bookmarks') || '[]');
                    const filteredBookmarks = allBookmarks.filter(bookmark => !bookmark.url.includes('music.apple.com'));
                    const reorderedBookmarks = newOrder.map(index => filteredBookmarks[index]);
                    
                    // Merge back with Apple Music items
                    const appleMusicItems = allBookmarks.filter(bookmark => bookmark.url.includes('music.apple.com'));
                    const finalBookmarks = [...reorderedBookmarks, ...appleMusicItems];
                    
                    localStorage.setItem('oreza_bookmarks', JSON.stringify(finalBookmarks));
                });
            });
            
            // Helper function to determine drop position
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.bookmark-item:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
            
            // Click outside to exit edit mode
            chatArea.addEventListener('click', (e) => {
                if (isEditMode && !e.target.closest('.bookmark-item')) {
                    isEditMode = false;
                    document.querySelectorAll('.remove-bookmark-btn').forEach(btn => {
                        btn.style.display = 'none';
                    });
                    document.querySelectorAll('.bookmark-item').forEach(i => {
                        i.style.animation = '';
                    });
                }
            });
            
            // Add event listeners for remove buttons
            document.querySelectorAll('.remove-bookmark-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(e.target.getAttribute('data-index'));
                    const bookmarks = JSON.parse(localStorage.getItem('oreza_bookmarks') || '[]');
                    bookmarks.splice(index, 1);
                    localStorage.setItem('oreza_bookmarks', JSON.stringify(bookmarks));
                    showBookmarks(); // Refresh display
                });
            });
        }

        function showTabs() {
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '';
            
            // Add title
            const titleDiv = document.createElement('div');
            titleDiv.style.cssText = 'font-weight: 600; font-size: 18px; margin: 24px 16px 16px 16px; color: #202124;';
            titleDiv.textContent = 'üóÇÔ∏è „Çø„ÉñÂ±•Ê≠¥';
            chatArea.appendChild(titleDiv);
            
            // Get tabs from localStorage
            const tabs = JSON.parse(localStorage.getItem('oreza_tabs') || '[]');
            
            if (tabs.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.style.cssText = 'color: #888; padding: 20px; text-align: center; margin: 0 16px;';
                emptyDiv.textContent = '„Çø„ÉñÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                chatArea.appendChild(emptyDiv);
                return;
            }
            
            // Grid container for thumbnails
            const gridContainer = document.createElement('div');
            gridContainer.style.cssText = 'display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; padding: 0 16px; margin-bottom: 16px;';
            
            // Display tabs (most recent first)
            tabs.slice().reverse().forEach(async (tab, index) => {
                // Extract album ID from Apple Music URL
                const albumMatch = tab.url.match(/album\/(\d+)/);
                const albumId = albumMatch ? albumMatch[1] : null;
                
                const cardDiv = document.createElement('div');
                cardDiv.style.cssText = 'position: relative; aspect-ratio: 1; background: #f5f5f5; border-radius: 12px; overflow: hidden; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
                
                // If it's an Apple Music link, fetch artwork
                if (albumId) {
                    // Try to fetch album artwork from iTunes API
                    try {
                        const response = await fetch(`https://itunes.apple.com/lookup?id=${albumId}&entity=album`);
                        const data = await response.json();
                        
                        if (data.results && data.results.length > 0) {
                            const artwork = data.results[0].artworkUrl100.replace('100x100', '400x400');
                            cardDiv.innerHTML = `
                                <img src="${artwork}" style="width: 100%; height: 100%; object-fit: cover;" alt="${tab.title}">
                                <button class="remove-tab-btn" data-index="${tabs.length - 1 - index}" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; cursor: pointer; font-size: 20px; color: #fff; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;" title="„Çø„ÉñÂ±•Ê≠¥„Åã„ÇâÂâäÈô§">√ó</button>
                                <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 12px 8px 8px; color: white; font-size: 11px; font-weight: 500; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                    ${tab.title.replace(/\s*-\s*Apple Music$/, '')}
                                </div>
                            `;
                        } else {
                            throw new Error('No artwork found');
                        }
                    } catch (error) {
                        // Fallback to icon if fetch fails
                        cardDiv.innerHTML = `
                            <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;">
                                üéµ
                            </div>
                            <button class="remove-tab-btn" data-index="${tabs.length - 1 - index}" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; cursor: pointer; font-size: 20px; color: #fff; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;" title="„Çø„ÉñÂ±•Ê≠¥„Åã„ÇâÂâäÈô§">√ó</button>
                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 12px 8px 8px; color: white; font-size: 11px; font-weight: 500; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                ${tab.title.replace(/\s*-\s*Apple Music$/, '')}
                            </div>
                        `;
                    }
                } else {
                    cardDiv.innerHTML = `
                        <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;">
                            üîó
                        </div>
                        <button class="remove-tab-btn" data-index="${tabs.length - 1 - index}" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; cursor: pointer; font-size: 20px; color: #fff; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;" title="„Çø„ÉñÂ±•Ê≠¥„Åã„ÇâÂâäÈô§">√ó</button>
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 12px 8px 8px; color: white; font-size: 11px; font-weight: 500; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                            ${tab.title}
                        </div>
                    `;
                }
                
                // Click to open URL
                cardDiv.onclick = (e) => {
                    if (!e.target.classList.contains('remove-tab-btn')) {
                        window.open(tab.url, '_self');
                    }
                };
                
                gridContainer.appendChild(cardDiv);
            });
            
            chatArea.appendChild(gridContainer);
            
            // Add event listeners for remove buttons
            document.querySelectorAll('.remove-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(e.target.getAttribute('data-index'));
                    tabs.splice(index, 1);
                    localStorage.setItem('oreza_tabs', JSON.stringify(tabs));
                    showTabs(); // Refresh display
                });
            });
        }

        // Update connection status UI (background mode - minimal UI disruption)
        function updateConnectionStatus() {
            const statusBar = document.getElementById('connectionStatus');
            if (!statusBar) return;
            
            switch(connectionStatus) {
                case 'connected':
                    statusBar.style.display = 'none';
                    break;
                case 'reconnecting':
                    // Only show status bar after 2nd attempt (background reconnection)
                    if (reconnectAttempts >= 2) {
                        statusBar.textContent = `ÂÜçÊé•Á∂ö‰∏≠...`;
                        statusBar.style.background = '#FFA500';
                        statusBar.style.display = 'block';
                    } else {
                        statusBar.style.display = 'none';
                    }
                    break;
                case 'disconnected':
                    statusBar.textContent = 'Êé•Á∂ö„ÅåÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    statusBar.style.background = '#FF0000';
                    statusBar.style.display = 'block';
                    break;
            }
        }
        

        
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
    
    <!-- ÈÄè„Åã„ÅóÊàª„Çã„Éú„Çø„É≥ -->
    <div id="oreza-back-btn" class="oreza-back-btn" aria-label="Êàª„Çã" style="display: none;">
        ‚óÄ Oreza
    </div>
    
    <script>
        (function () {
            const BACK_BTN_ID = 'oreza-back-btn';
            const HOME_URL = '/';
            
            const backBtn = document.getElementById(BACK_BTN_ID);
            
            // ---- ÂÜÖÈÉ®Áî®„ÅÆÁ∞°Êòì„Çπ„Çø„ÉÉ„ÇØÔºàOrezaÂÜÖURL„Å†„ÅëË®òÈå≤Ôºâ ----
            const STORAGE_KEY = 'oreza_nav_stack_v1';
            
            function getStack() {
                try {
                    const raw = sessionStorage.getItem(STORAGE_KEY);
                    return raw ? JSON.parse(raw) : [];
                } catch (e) {
                    return [];
                }
            }
            
            function setStack(stack) {
                try {
                    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(stack));
                } catch (e) {
                    // ÁÑ°Ë¶ñ
                }
            }
            
            function pushCurrentUrl() {
                const stack = getStack();
                const current = location.pathname + location.search + location.hash;
                if (stack[stack.length - 1] !== current) {
                    stack.push(current);
                    setStack(stack);
                }
                updateBackButtonVisibility();
            }
            
            function popUrl() {
                const stack = getStack();
                stack.pop();          // ‰ªä„ÅÆURL„ÇíÊç®„Å¶„Çã
                const prev = stack.pop(); // ‰∏ÄÂÄãÂâç„ÇíÂèñ„ÇäÂá∫„Åô
                setStack(stack);
                return prev;
            }
            
            // ---- „Éú„Çø„É≥Ë°®Á§∫Âà∂Âæ° ----
            function updateBackButtonVisibility() {
                const stack = getStack();
                const hasInternalBack = stack.length > 1;
                const hasHistoryBack = window.history.length > 1;
                
                if (hasInternalBack || hasHistoryBack) {
                    backBtn.classList.add('visible');
                } else {
                    backBtn.classList.remove('visible');
                }
            }
            
            // ---- ÂÆüÈöõ„ÅÆ„ÄåÊàª„Çã„ÄçÂãï‰Ωú ----
            function handleBack() {
                const stack = getStack();
                const hasInternalBack = stack.length > 1;
                
                if (hasInternalBack) {
                    // „Åæ„Åö Oreza ÂÜÖ„Çπ„Çø„ÉÉ„ÇØ„ÅßÊàª„Çã
                    const prev = popUrl();
                    if (prev) {
                        location.href = prev;
                        return;
                    }
                }
                
                // ÂÜÖÈÉ®„Çπ„Çø„ÉÉ„ÇØ„ÅåÁÑ°„ÅÑ or Â§±Êïó ‚Üí „Éñ„É©„Ç¶„Ç∂Â±•Ê≠¥„Å´‰ªª„Åõ„Çã
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    // „Åù„Çå„ÇÇÁÑ°„ÅÑÂ†¥Âêà„ÅØ„Éõ„Éº„É†„Å∏ÈÄÄÈÅø
                    location.href = HOME_URL;
                }
            }
            
            // ---- „Ç§„Éô„É≥„ÉàÁôªÈå≤ ----
            function initOrezaBackButton() {
                if (!backBtn) return;
                
                // ÂàùÊúü„Çπ„Çø„ÉÉ„ÇØ„Å´ÁèæURL„ÇíÁ©ç„ÇÄ
                pushCurrentUrl();
                
                // „Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ„ÅßÊàª„Çã
                backBtn.addEventListener('click', function () {
                    handleBack();
                });
                
                // SPA„ÅÆÂ†¥ÂêàÔºö„É´„Éº„Çø„Éº„ÅßÁîªÈù¢Âàá„ÇäÊõø„ÅàÊôÇ„Å´ pushCurrentUrl() „ÇíÂëº„Çì„Åß„Åª„Åó„ÅÑ
                window.addEventListener('oreza:navigated', function () {
                    pushCurrentUrl();
                });
                
                // ÈÄöÂ∏∏„ÅÆ„Éñ„É©„Ç¶„Ç∂Êàª„Çã/ÈÄ≤„ÇÄÊìç‰Ωú„ÅßÁä∂ÊÖã„ÅåÂ§â„Çè„Å£„Åü„Å®„Åç
                window.addEventListener('popstate', function () {
                    // Â±•Ê≠¥„ÅåÂãï„ÅÑ„Åü„ÅÆ„Åß„Éú„Çø„É≥Ë°®Á§∫„Å†„ÅëÊõ¥Êñ∞
                    updateBackButtonVisibility();
                });
                
                // „É≠„Éº„ÉâÂÆå‰∫ÜÂæå„Å´‰∏ÄÂ∫¶Ë°®Á§∫Áä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                window.addEventListener('load', function () {
                    updateBackButtonVisibility();
                });
            }
            
            initOrezaBackButton();
        })();
    </script>
</body>
</html>
